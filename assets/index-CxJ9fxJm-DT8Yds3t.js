import{P as v,i as S,j as V,F as C,m as y,T as b,N as x,D as T,n as O,o as p,h as D,a as A}from"./MilkdownEditor-CQzOidG1.js";import"./index-Bso2Fy82.js";import"./mutex-yV3mxE7x.js";function N(o={}){return new v({view(e){return new R(e,o)}})}class R{constructor(e,t){var i;this.editorView=e,this.cursorPos=null,this.element=null,this.timeout=-1,this.width=(i=t.width)!==null&&i!==void 0?i:1,this.color=t.color===!1?void 0:t.color||"black",this.class=t.class,this.handlers=["dragover","dragend","drop","dragleave"].map(r=>{let l=n=>{this[r](n)};return e.dom.addEventListener(r,l),{name:r,handler:l}})}destroy(){this.handlers.forEach(({name:e,handler:t})=>this.editorView.dom.removeEventListener(e,t))}update(e,t){this.cursorPos!=null&&t.doc!=e.state.doc&&(this.cursorPos>e.state.doc.content.size?this.setCursor(null):this.updateOverlay())}setCursor(e){e!=this.cursorPos&&(this.cursorPos=e,e==null?(this.element.parentNode.removeChild(this.element),this.element=null):this.updateOverlay())}updateOverlay(){let e=this.editorView.state.doc.resolve(this.cursorPos),t=!e.parent.inlineContent,i;if(t){let s=e.nodeBefore,d=e.nodeAfter;if(s||d){let c=this.editorView.nodeDOM(this.cursorPos-(s?s.nodeSize:0));if(c){let u=c.getBoundingClientRect(),f=s?u.bottom:u.top;s&&d&&(f=(f+this.editorView.nodeDOM(this.cursorPos).getBoundingClientRect().top)/2),i={left:u.left,right:u.right,top:f-this.width/2,bottom:f+this.width/2}}}}if(!i){let s=this.editorView.coordsAtPos(this.cursorPos);i={left:s.left-this.width/2,right:s.left+this.width/2,top:s.top,bottom:s.bottom}}let r=this.editorView.dom.offsetParent;this.element||(this.element=r.appendChild(document.createElement("div")),this.class&&(this.element.className=this.class),this.element.style.cssText="position: absolute; z-index: 50; pointer-events: none;",this.color&&(this.element.style.backgroundColor=this.color)),this.element.classList.toggle("prosemirror-dropcursor-block",t),this.element.classList.toggle("prosemirror-dropcursor-inline",!t);let l,n;if(!r||r==document.body&&getComputedStyle(r).position=="static")l=-pageXOffset,n=-pageYOffset;else{let s=r.getBoundingClientRect();l=s.left-r.scrollLeft,n=s.top-r.scrollTop}this.element.style.left=i.left-l+"px",this.element.style.top=i.top-n+"px",this.element.style.width=i.right-i.left+"px",this.element.style.height=i.bottom-i.top+"px"}scheduleRemoval(e){clearTimeout(this.timeout),this.timeout=setTimeout(()=>this.setCursor(null),e)}dragover(e){if(!this.editorView.editable)return;let t=this.editorView.posAtCoords({left:e.clientX,top:e.clientY}),i=t&&t.inside>=0&&this.editorView.state.doc.nodeAt(t.inside),r=i&&i.type.spec.disableDropCursor,l=typeof r=="function"?r(this.editorView,t,e):r;if(t&&!l){let n=t.pos;if(this.editorView.dragging&&this.editorView.dragging.slice){let s=S(this.editorView.state.doc,n,this.editorView.dragging.slice);s!=null&&(n=s)}this.setCursor(n),this.scheduleRemoval(5e3)}}dragend(){this.scheduleRemoval(20)}drop(){this.scheduleRemoval(20)}dragleave(e){(e.target==this.editorView.dom||!this.editorView.dom.contains(e.relatedTarget))&&this.setCursor(null)}}class a extends p{constructor(e){super(e,e)}map(e,t){let i=e.resolve(t.map(this.head));return a.valid(i)?new a(i):p.near(i)}content(){return y.empty}eq(e){return e instanceof a&&e.head==this.head}toJSON(){return{type:"gapcursor",pos:this.head}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for GapCursor.fromJSON");return new a(e.resolve(t.pos))}getBookmark(){return new g(this.anchor)}static valid(e){let t=e.parent;if(t.isTextblock||!B(e)||!F(e))return!1;let i=t.type.spec.allowGapCursor;if(i!=null)return i;let r=t.contentMatchAt(e.index()).defaultType;return r&&r.isTextblock}static findGapCursorFrom(e,t,i=!1){e:for(;;){if(!i&&a.valid(e))return e;let r=e.pos,l=null;for(let n=e.depth;;n--){let s=e.node(n);if(t>0?e.indexAfter(n)<s.childCount:e.index(n)>0){l=s.child(t>0?e.indexAfter(n):e.index(n)-1);break}else if(n==0)return null;r+=t;let d=e.doc.resolve(r);if(a.valid(d))return d}for(;;){let n=t>0?l.firstChild:l.lastChild;if(!n){if(l.isAtom&&!l.isText&&!x.isSelectable(l)){e=e.doc.resolve(r+l.nodeSize*t),i=!1;continue e}break}l=n,r+=t;let s=e.doc.resolve(r);if(a.valid(s))return s}return null}}}a.prototype.visible=!1;a.findFrom=a.findGapCursorFrom;p.jsonID("gapcursor",a);class g{constructor(e){this.pos=e}map(e){return new g(e.map(this.pos))}resolve(e){let t=e.resolve(this.pos);return a.valid(t)?new a(t):p.near(t)}}function B(o){for(let e=o.depth;e>=0;e--){let t=o.index(e),i=o.node(e);if(t==0){if(i.type.spec.isolating)return!0;continue}for(let r=i.child(t-1);;r=r.lastChild){if(r.childCount==0&&!r.inlineContent||r.isAtom||r.type.spec.isolating)return!0;if(r.inlineContent)return!1}}return!0}function F(o){for(let e=o.depth;e>=0;e--){let t=o.indexAfter(e),i=o.node(e);if(t==i.childCount){if(i.type.spec.isolating)return!0;continue}for(let r=i.child(t);;r=r.firstChild){if(r.childCount==0&&!r.inlineContent||r.isAtom||r.type.spec.isolating)return!0;if(r.inlineContent)return!1}}return!0}function E(){return new v({props:{decorations:J,createSelectionBetween(o,e,t){return e.pos==t.pos&&a.valid(t)?new a(t):null},handleClick:z,handleKeyDown:L,handleDOMEvents:{beforeinput:M}}})}const L=V({ArrowLeft:h("horiz",-1),ArrowRight:h("horiz",1),ArrowUp:h("vert",-1),ArrowDown:h("vert",1)});function h(o,e){const t=o=="vert"?e>0?"down":"up":e>0?"right":"left";return function(i,r,l){let n=i.selection,s=e>0?n.$to:n.$from,d=n.empty;if(n instanceof b){if(!l.endOfTextblock(t)||s.depth==0)return!1;d=!1,s=i.doc.resolve(e>0?s.after():s.before())}let c=a.findGapCursorFrom(s,e,d);return c?(r&&r(i.tr.setSelection(new a(c))),!0):!1}}function z(o,e,t){if(!o||!o.editable)return!1;let i=o.state.doc.resolve(e);if(!a.valid(i))return!1;let r=o.posAtCoords({left:t.clientX,top:t.clientY});return r&&r.inside>-1&&x.isSelectable(o.state.doc.nodeAt(r.inside))?!1:(o.dispatch(o.state.tr.setSelection(new a(i))),!0)}function M(o,e){if(e.inputType!="insertCompositionText"||!(o.state.selection instanceof a))return!1;let{$from:t}=o.state.selection,i=t.parent.contentMatchAt(t.index()).findWrapping(o.state.schema.nodes.text);if(!i)return!1;let r=C.empty;for(let n=i.length-1;n>=0;n--)r=C.from(i[n].createAndFill(null,r));let l=o.state.tr.replace(t.pos,t.pos,new y(r,0,0));return l.setSelection(b.near(l.doc.resolve(t.pos+1))),o.dispatch(l),!1}function J(o){if(!(o.selection instanceof a))return null;let e=document.createElement("div");return e.className="ProseMirror-gapcursor",T.create(o.doc,[O.widget(o.selection.head,e,{key:"gapcursor"})])}function w(o,e){return Object.assign(o,{meta:{package:"@milkdown/plugin-cursor",...e}}),o}const m=D({},"dropCursorConfig");w(m,{displayName:"Ctx<dropCursor>"});const k=A(o=>N(o.get(m.key)));w(k,{displayName:"Prose<dropCursor>"});const P=A(()=>E());w(P,{displayName:"Prose<gapCursor>"});const X=[m,k,P],q=(o,e)=>{o.config(t=>{t.update(m.key,()=>{var i,r;return{class:"crepe-drop-cursor",width:(i=e==null?void 0:e.width)!=null?i:4,color:(r=e==null?void 0:e.color)!=null?r:!1}})}).use(X)};export{q as defineFeature};
